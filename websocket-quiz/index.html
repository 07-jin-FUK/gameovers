<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>WebSocket Quiz</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <style>
        #quiz-section {
            display: none;
        }

        #waiting-message {
            display: none;
        }

        #ready-message {
            display: none;
        }

        .correct {
            color: red;
            display: inline;
        }

        .correct::after {
            content: ' 〇';
        }

        .incorrect {
            color: blue;
        }

        input[disabled] {
            background-color: lightgray;
        }

        #end-game {
            display: none;
        }

        #next-question {
            display: none;
        }

        .hp-bar {
            height: 20px;
            background-color: green;
            text-align: center;
            color: white;
        }
    </style>
</head>

<body>
    <h1>Quiz Time!</h1>

    <div id="user-section">
        <input type="text" id="username" placeholder="Enter your username">
        <button onclick="startQuiz()">Start Quiz</button>
    </div>

    <div id="waiting-message">
        <p>対戦相手を募集しています...</p>
    </div>

    <div id="ready-message">
        <p>対戦相手が揃いました。問題を開始します...</p>
        <p id="countdown"></p>
    </div>

    <div id="quiz-section">
        <div id="quiz"></div>
        <input type="text" id="answer" placeholder="Type your answer here">
        <button onclick="sendAnswer()">Submit</button>
        <div id="responses"></div>
    </div>

    <div id="next-question">
        <p>次の問題へ進むボタンを押してください</p>
        <button onclick="readyForNextQuestion()">次の問題へ進む</button>
        <p id="waiting-next"></p>
    </div>

    <div id="end-game">
        <p id="winner-message"></p>
        <button onclick="restartGame()">Restart Game</button>
    </div>

    <div id="status-section">
        <div id="scores"></div>
        <div id="hp-bars"></div>
    </div>

    <script>
        let ws;
        let user;
        let tabId = generateTabId();

        function generateTabId() {
            return Math.random().toString(36).substr(2, 9);
        }

        function connectWebSocket() {
            ws = new WebSocket('ws://localhost:8081');

            ws.onopen = () => {
                console.log('Connected to WebSocket server');
                ws.send(JSON.stringify({ type: 'register', user: user, tabId: tabId }));
            };

            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                console.log('Received message from server:', message);

                if (message.type === 'readyToStart') {
                    document.getElementById('waiting-message').style.display = 'none';
                    document.getElementById('ready-message').style.display = 'block';
                    document.getElementById('status-section').style.display = 'block';
                    updateScores(message.scores);
                    updateHP(message.hp);
                    startCountdown();
                }
                if (message.type === 'startQuiz') {
                    document.getElementById('ready-message').style.display = 'none';
                    document.getElementById('quiz-section').style.display = 'block';
                    document.getElementById('next-question').style.display = 'none';
                    document.getElementById('quiz').textContent = message.question;
                    document.getElementById('responses').innerHTML = '';
                    enableInput();
                }
                if (message.type === 'answer') {
                    const responseElement = document.createElement('p');
                    responseElement.innerHTML = `<strong>${message.user}:</strong> ${message.answer}`;
                    if (message.correct) {
                        responseElement.classList.add('correct');
                        disableInput();
                        document.getElementById('next-question').style.display = 'block';
                    } else {
                        responseElement.classList.add('incorrect');
                    }
                    document.getElementById('responses').appendChild(responseElement);
                }
                if (message.type === 'updateScores') {
                    updateScores(message.scores);
                    updateHP(message.hp);
                }
                if (message.type === 'endGame') {
                    document.getElementById('quiz-section').style.display = 'none';
                    document.getElementById('ready-message').style.display = 'none';
                    document.getElementById('next-question').style.display = 'none';
                    document.getElementById('end-game').style.display = 'block';
                    document.getElementById('winner-message').textContent = `${message.winner} has won the game!`;
                    updateScores(message.scores);
                    updateHP(message.hp);
                }
                if (message.type === 'showNextButton') {
                    document.getElementById('next-question').style.display = 'block';
                }
                if (message.type === 'waitingForNext') {
                    document.getElementById('waiting-next').textContent = `Waiting for ${message.usersReady.join(", ")} to proceed...`;
                }
                if (message.type === 'startNextQuiz') {
                    document.getElementById('next-question').style.display = 'none';
                    startCountdownForNext();
                }
                if (message.type === 'userDisconnected') {
                    alert(`${message.user} has disconnected. Please wait for reconnection.`);
                    document.getElementById('next-question').style.display = 'none';
                    document.getElementById('quiz-section').style.display = 'none';
                    document.getElementById('ready-message').style.display = 'none';
                    document.getElementById('user-section').style.display = 'block';
                }
            };

            ws.onclose = () => {
                console.log('WebSocket connection closed. Reconnecting...');
                setTimeout(connectWebSocket, 1000);
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        }

        function sendAnswer() {
            const answerInput = document.getElementById('answer');
            const answer = answerInput.value;

            if (ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'answer', user: user, answer: answer }));
                answerInput.value = '';
            } else {
                console.error('WebSocket is not open. Ready state: ' + ws.readyState);
            }
        }

        function readyForNextQuestion() {
            if (ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'readyForNextQuestion', user: user }));
            }
        }

        function startQuiz() {
            fetch('http://localhost:8080/reset', { method: 'POST' })
                .then(response => response.text())
                .then(data => {
                    console.log(data);
                    user = document.getElementById('username').value;
                    if (user) {
                        console.log(`Starting quiz for user: ${user}`);
                        document.getElementById('user-section').style.display = 'none';
                        document.getElementById('waiting-message').style.display = 'block';
                        document.getElementById('status-section').style.display = 'block';
                        connectWebSocket();
                    } else {
                        alert('Please enter a username');
                    }
                })
                .catch(error => console.error('Error resetting game:', error));
        }

        function startCountdown() {
            let countdown = 5;
            const countdownElement = document.getElementById('countdown');
            countdownElement.textContent = countdown;
            const interval = setInterval(() => {
                countdown--;
                countdownElement.textContent = countdown;
                if (countdown <= 0) {
                    clearInterval(interval);
                }
            }, 1000);
        }

        function startCountdownForNext() {
            document.getElementById('quiz-section').style.display = 'none';
            document.getElementById('ready-message').style.display = 'block';
            startCountdown();
            setTimeout(() => {
                document.getElementById('ready-message').style.display = 'none';
                document.getElementById('quiz-section').style.display = 'block';
            }, 5000);
        }

        function disableInput() {
            document.getElementById('answer').disabled = true;
            document.querySelector('button[onclick="sendAnswer()"]').disabled = true;
        }

        function enableInput() {
            document.getElementById('answer').disabled = false;
            document.querySelector('button[onclick="sendAnswer()"]').disabled = false;
        }

        function updateScores(scores) {
            const scoresElement = document.getElementById('scores');
            scoresElement.innerHTML = '<h3>Scores:</h3>';
            scores.forEach(([user, score]) => {
                scoresElement.innerHTML += `<p><strong>${user}:</strong> ${score}</p>`;
            });
            scoresElement.style.display = 'block';
        }

        function updateHP(hp) {
            const hpBarsElement = document.getElementById('hp-bars');
            hpBarsElement.innerHTML = '<h3>HP:</h3>';
            hp.forEach(([user, hp]) => {
                const hpBar = `<div class="hp-bar" style="width: ${hp * 20}%;"></div>`;
                hpBarsElement.innerHTML += `<p><strong>${user}:</strong> ${hpBar}</p>`;
            });
        }

        function restartGame() {
            document.getElementById('end-game').style.display = 'none';
            document.getElementById('responses').innerHTML = '';
            document.getElementById('scores').innerHTML = '';
            document.getElementById('hp-bars').innerHTML = '';
            document.getElementById('status-section').style.display = 'none';
            document.getElementById('user-section').style.display = 'block';
            user = '';
            ws.close();
        }
    </script>
</body>

</html>